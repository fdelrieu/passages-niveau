<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Passages √† Niveau √† Proximit√©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.7.5/proj4.js"></script>
  <style>
    body { margin: 0; font-family: sans-serif; }
    #map { height: 100vh; }
    #info { position: absolute; top: 10px; left: 10px; background: white; padding: 10px; z-index: 1000; border-radius: 8px; box-shadow: 0 0 5px #999; }
  </style>
</head>
<body>
  <div id="info">üìç Recherche de votre position...</div>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    const info = document.getElementById('info');
    let map;

    function getRadiusByZoom(zoomLevel) {
      // D√©finir le rayon en fonction du niveau de zoom
      const zoomToRadius = {
        18: 1, 17: 2, 16: 3, 15: 4, 14: 5, 13: 10, 12: 15, 11: 20, 10: 30, 9: 40, 8: 50
      };
      return zoomToRadius[zoomLevel] || 50; // Rayon par d√©faut si le niveau de zoom n'est pas d√©fini
    }

    function fetchData(lat, lon, radiusKm) {
      const url = `https://ressources.data.sncf.com/api/explore/v2.1/catalog/datasets/liste-des-passages-a-niveau/records?where=within_distance(geo_point_2d, geom'POINT(${lon} ${lat})', ${radiusKm * 1000})`;

      fetch(url)
        .then(res => res.json())
        .then(data => {
          map.eachLayer(layer => {
            if (layer instanceof L.Marker && !layer._userMarker) {
              map.removeLayer(layer);
            }
          });

          if (data.results.length === 0) {
            info.textContent = "Aucun passage √† niveau trouv√© √† proximit√©.";
            return;
          }
          info.textContent = `${data.results.length} passage(s) √† niveau trouv√©s dans un rayon de ${radiusKm} km.`;
          data.results.forEach(pn => {
            if (pn.geo_point_2d) {
              L.marker([pn.geo_point_2d.lat, pn.geo_point_2d.lon])
                .addTo(map)
                .bindPopup(`PN n¬∞${pn.libelle}<br>${pn.commune || 'Inconnu'} (${pn.departement || 'Inconnu'})`);
            }
          });
        })
        .catch(err => {
          console.error(err);
          info.textContent = "Erreur lors de la r√©cup√©ration des donn√©es.";
        });
    }

    function showMap(lat, lon) {
      if (map) {
        map.remove();
      }
      map = L.map('map').setView([lat, lon], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      const userMarker = L.marker([lat, lon]).addTo(map).bindPopup('üìç Vous √™tes ici').openPopup();
      userMarker._userMarker = true;

      const radiusKm = getRadiusByZoom(map.getZoom());
      fetchData(lat, lon, radiusKm);

      map.on('zoomend', function() {
        const newRadiusKm = getRadiusByZoom(map.getZoom());
        fetchData(lat, lon, newRadiusKm);
      });
    }

    function convertL93ToWGS84(x_l93, y_l93) {
      proj4.defs("EPSG:2154", "+proj=lcc +lat_1=49 +lat_2=44 +lat_0=46.5 +lon_0=3 +x_0=700000 +y_0=6600000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs");
      proj4.defs("WGS84", "+proj=longlat +datum=WGS84 +no_defs");
      const coordsWGS84 = proj4("EPSG:2154", "WGS84", [x_l93, y_l93]);
      return { longitude: coordsWGS84[0], latitude: coordsWGS84[1] };
    }

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        pos => {
          showMap(pos.coords.latitude, pos.coords.longitude);
        },
        err => {
          info.textContent = "Erreur : impossible d'obtenir votre position.";
          const x_l93 = 462292.84380000085;
          const y_l93 = 6255500.5;
          const { latitude, longitude } = convertL93ToWGS84(x_l93, y_l93);
          showMap(latitude, longitude);
        }
      );
    } else {
      info.textContent = "La g√©olocalisation n'est pas support√©e.";
      const x_l93 = 462292.84380000085;
      const y_l93 = 6255500.5;
      const { latitude, longitude } = convertL93ToWGS84(x_l93, y_l93);
      showMap(latitude, longitude);
    }
  </script>
</body>
</html>
