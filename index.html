<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Passages √† Niveau √† Proximit√©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <style>
    body { margin: 0; font-family: sans-serif; }
    #map { height: 100vh; }
    #info { position: absolute; top: 10px; left: 10px; background: white; padding: 10px; z-index: 1000; border-radius: 8px; box-shadow: 0 0 5px #999; }
  </style>
</head>
<body>
  <div id="info">üìç Recherche de votre position...</div>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    const info = document.getElementById('info');

    function showMap(lat, lon) {
      const map = L.map('map').setView([lat, lon], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
      const userMarker = L.marker([lat, lon]).addTo(map).bindPopup('üìç Vous √™tes ici').openPopup();

      const radiusKm = 5;
      const url = `https://ressources.data.sncf.com/api/explore/v2.1/catalog/datasets/liste-des-passages-a-niveau/records?where=within_distance(geo_point_2d,geom'POINT(${lon} ${lat})',${radiusKm * 1000})&limit=100`;

      fetch(url)
        .then(res => res.json())
        .then(data => {
          if (data.results.length === 0) {
            info.textContent = "Aucun passage √† niveau trouv√© √† proximit√©.";
            return;
          }
          info.textContent = `${data.results.length} passage(s) √† niveau trouv√©s dans un rayon de ${radiusKm} km.`;
          data.results.forEach(pn => {
            if (pn.geo_point_2d) {
              L.marker([pn.geo_point_2d.lat, pn.geo_point_2d.lon])
                .addTo(map)
                .bindPopup(`PN n¬∞${pn.libelle}<br>${pn.commune || 'Inconnu'} (${pn.departement || 'Inconnu'})`);
            }
          });
        })
        .catch(err => {
          console.error(err);
          info.textContent = "Erreur lors de la r√©cup√©ration des donn√©es.";
        });
    }

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        pos => {
          showMap(pos.coords.latitude, pos.coords.longitude);
        },
        err => {
          info.textContent = "Erreur : impossible d'obtenir votre position.";
        }
      );
    } else {
      info.textContent = "La g√©olocalisation n'est pas support√©e.";
    }
  </script>
</body>
</html>
